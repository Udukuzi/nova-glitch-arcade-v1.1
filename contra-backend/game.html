<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contra - Python Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
        }
        
        #game-container {
            position: relative;
            width: 1280px;
            height: 720px;
            max-width: 100%;
            max-height: 100vh;
            background: #1a1a2e;
            border: 2px solid #00ff88;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #game-canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ff88;
            font-size: 20px;
            text-align: center;
            z-index: 10;
        }
        
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff4444;
            text-align: center;
            padding: 20px;
            background: rgba(255, 68, 68, 0.1);
            border: 2px solid #ff4444;
            border-radius: 8px;
            max-width: 600px;
            z-index: 10;
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="loading">Starting Contra Game...</div>
        <canvas id="game-canvas"></canvas>
        <div id="error"></div>
    </div>
    
    <script>
        const PARENT_ORIGIN = window.location.origin.includes('localhost') 
            ? 'http://localhost:5173' 
            : window.location.origin;

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        
        canvas.width = 1280;
        canvas.height = 720;
        
        let gameRunning = false;
        let animationFrame = null;
        let frameRequestPending = false;
        
        // Handle keyboard input from parent
        window.addEventListener('message', (event) => {
            if (event.origin !== PARENT_ORIGIN && !event.origin.includes('localhost')) {
                return;
            }
            
            if (!event.data || typeof event.data !== 'object' || !event.data.type) {
                return;
            }
            
            const keyCode = event.data.key;
            if (event.data.type === 'KEY_DOWN' && typeof keyCode === 'string') {
                sendKeyToServer(keyCode, true);
            } else if (event.data.type === 'KEY_UP' && typeof keyCode === 'string') {
                sendKeyToServer(keyCode, false);
            }
        });
        
        function sendKeyToServer(key, pressed) {
            fetch('/api/game/key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key, pressed })
            }).catch(err => console.error('Failed to send key:', err));
        }
        
        function startGame() {
            fetch('/api/game/start', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'started') {
                        gameRunning = true;
                        loadingDiv.style.display = 'none';
                        setTimeout(() => gameLoop(), 500);
                    } else {
                        showError('Failed to start game: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(err => {
                    showError('Failed to connect to game server: ' + err.message);
                });
        }
        
        function showError(message) {
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `<h3>Error</h3><p>${message}</p>`;
        }
        
        function gameLoop() {
            if (!gameRunning || frameRequestPending) return;
            
            frameRequestPending = true;
            
            fetch('/api/game/frame')
                .then(res => res.json())
                .then(data => {
                    frameRequestPending = false;
                    
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    if (data.frame) {
                        const img = new Image();
                        img.onload = () => {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        };
                        img.onerror = () => {
                            frameRequestPending = false;
                        };
                        img.src = data.frame;
                    }
                    
                    // ~30 FPS
                    setTimeout(() => {
                        animationFrame = requestAnimationFrame(gameLoop);
                    }, 33);
                })
                .catch(err => {
                    frameRequestPending = false;
                    console.error('Frame fetch error:', err);
                    setTimeout(() => {
                        animationFrame = requestAnimationFrame(gameLoop);
                    }, 100);
                });
        }
        
        function sendScoreUpdate(score) {
            window.parent.postMessage({
                type: 'SCORE_UPDATE',
                score: Math.max(0, Math.min(score, 999999))
            }, PARENT_ORIGIN);
        }
        
        function sendGameOver(score) {
            window.parent.postMessage({
                type: 'GAME_OVER',
                score: Math.max(0, Math.min(score, 999999))
            }, PARENT_ORIGIN);
        }
        
        // Start game on load
        startGame();
        
        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            gameRunning = false;
            if (animationFrame) cancelAnimationFrame(animationFrame);
            fetch('/api/game/stop', { method: 'POST' }).catch(() => {});
        });
    </script>
</body>
</html>
